<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="../CSS/navileiste.css">
    <link rel="stylesheet" type="text/css" href="../CSS/anmeldung.css">
    <link rel="stylesheet" type="text/css" href="../CSS/fussleiste.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="../Javascript/forAll.js"></script>
    <script src="../Javascript/sessionHandling.js"></script>
    <script src="../Javascript/anmeldung.js"></script>
    <script src="../Javascript/account.js"></script> <!--Für Logout-->

    <meta charset="utf-8">
    <title>HS-Shop: Anmelden/Registrieren</title>

    <script>
        function checkIfPLZ(){
            let plz = $('#plz').val();
            let plzStr = plz.toString();
            if (plzStr.length >5){
                document.getElementById('alertPLZ').innerHTML = "PLZ falsch!";
                return false;
            }
            document.getElementById('alertPLZ').innerHTML = "";
            return true;
        }
    </script>
</head> 

<body>
    <!--FLEXBOX-->
    <nav>
        <div class="flexbox">
            <div class="logo" >
                <div class="logo_img"><a title="Home" href="../HTML/index.html"><img src="../Bilder/navi_logo_shop.png" alt="An Error occured!"></a></div>
            </div>
    
            <div class="menu">
                <div class="menu_top">
    
                    <div class="menu_top_left">
                        <a href="../HTML/kontakt.html">Kontakt</a>
                        <a href="https://www.hs-albsig.de/hochschule/ueber-uns/hochschulportrait">Über die Hochschule</a>
                    </div>
    
                    <div class="menu_top_right">
                        <div class="searchbar"><form action="../HTML/suche.html" method="">
                            <input type="search" id="suche" maxlength="50" placeholder="Suche..">
                            <button type="submit" onclick="search()">Go!</button></form></div>
                        <div class="tooltip">
                            <a title="Account" href="../HTML/account.html"><img src="../Bilder/navi_account.png" alt="Account"></a>
                            <span class="tooltiptext">
                                <a href="../HTML/anmeldung.html"><button>Anmelden/Registrieren</button></a><br>
                                <input type="button" onclick="logout()" value="Ausloggen">
                            </span>

                        </div>
                    </div>
                </div>
    
                <hr width="95%">
    
                <div class="menu_bottom">
                    <div class="menu_item"><a href="../HTML/produkt_hauptseite.html?oberkategorie=Sale">Sale</a></div>
                    <div class="menu_item"><a href="../HTML/produkt_hauptseite.html?oberkategorie=Männer">Männer</a></div>
                    <div class="menu_item"><a href="../HTML/produkt_hauptseite.html?oberkategorie=Frauen">Frauen</a></div>
                    <div class="menu_item"><a href="../HTML/produkt_hauptseite.html?oberkategorie=Accessoires">Accessoires</a></div>
                    <div class="menu_item"><a title="Warenkorb" href="../HTML/warenkorb.html"><img src="../Bilder/navi_warenkorb.png" alt="Cart"></a></div>
                </div>
            </div>
                
        </div>
    </nav>
    <!--ENDE FLEXBOX-->

    <!--FORMULAR-->
    <div class="content">
        
        <!--Anmeldung-->
        <div class="anmeldung">
            <h3>Anmelden</h3>
            <div class="anmeldung_content">
                <form class="anmeldeformular" name="anmeldeformular" id="anmeldeformular" >
                    <text>Benutzername oder E-Mail-Adresse:</text><br>
                    <input type="text" id="name" name="anmelden" maxlength="40"><br>
                    <b id="alertWrongUsername" style="color: red; font-size: 13px;"></b><br>
                    <text>Passwort:</text><br>
                    <input type="password" id='passwort' name="anmelden" minlength="8"><br>
                    <b id="alertWrongPassword" style="color: red; font-size: 13px;"></b><br>
                    <a href="../HTML/reset_change_password.html">Passwort vergessen?</a><br>
                    <input type="submit" value="Anmelden">
                </form>
            </div>
        </div>

        <!--oder text-->
        <div class="oder">
            <hr>
            <b>ODER</b>
            <hr>
        </div>

        <!--Registrierung-->
        <div class="registrierung">
            <h3>Registrieren</h3>
            <div class="registrierung_content">

                <form class="registformular" name="registrierungsform" id="registrierungsform" method='POST'>
                    <div class="form_anrede">
                        <text>Anrede</text><br>
                        <label>Herr</label><input type="radio" class="anrede" name="anrede" value="Herr" checked>
                        <label>Frau</label><input type="radio" class="anrede" name="anrede" value="Frau">
                    </div>

                    <div class="form_vorname">
                        <text>Vorname</text><br>
                        <input type="text" id="vorname" name="vorname" maxlength="40" required>
                    </div>

                    <div class="form_nachname">
                        <text>Nachname</text><br>
                        <input type="text" id="nachname" name="nachname" maxlength="40" required>
                    </div>

                    <div class="form_benutzername">
                        <text>Benutzername</text><br>
                        <input type="text" id="benutzername" name="benutzername" maxlength="20" required><br>
                        <b id="alertUsername" style="color: red; font-size: 13px;"></b>
                    </div>

                    <div class="email">
                        <text>E-Mail</text><br>
                        <input type="email" id="email" name="email" required>
                    </div>

                    <div class="passwort">
                        <text>Passwort</text><br>
                        <input type="password" id="passwort1" name="passwort" minlength="8" required onkeyup="comparePasswords()"> 
                    </div>

                    <div class="passwort">
                        <text>Passwort Wiederholung</text><br>
                        <input type="password" id="passwort_wdh" name="passwort_wdh" minlength="8" required onkeyup="comparePasswords()"><br>
                        <b id="alertPassword" style="color: red; font-size: 13px;"> </b> <!--Für die Ausgabe comparePasswords() in anmeldung.js-->
                    </div>

                    <div class="sicherheitsfrage">
                        <text>Sicherheitsfrage</text><br>
                        <select id="sicherheitsfrage" name="sicherheitsfrage">
                            <option value="" selected="on"></option>
                            <option value="Wann hast du dein Handy gekauft? (Jahr angeben)">Wann hast du dein Handy gekauft? (Jahr angeben)</option>
                            <option value="Wo bist du geboren?">Wo bist du geboren?</option>
                            <option value="Wie ist der Geburtsname Ihrer Mutter?">Wie ist der Geburtsname Ihrer Mutter?</option>
                        </select>
                    </div>

                    <div class="sicherheitsantwort">
                        <text>Antwort</text><br>
                        <input type="text" id="sicherheitsantwort" name="sicherheitsantwort" required>
                    </div>
					
					<div class="form_strasse">
                        <text>Straße, Hausnummer</text><br>
                        <input type="text" id="strasse" name="strasse" required>
                    </div>
					
					<div class="form_plz">
                        <text>PLZ</text><br>
                        <input type="number" id="plz" name="plz" required onkeyup="checkIfPLZ()"><br>
                        <b id="alertPLZ" style="color: red; font-size: 13px;"> </b> 
                    </div>
					
					<div class="form_ort">
                        <text>Ort</text><br>
                        <input type="text" id="ort" name="ort" required>
                    </div>
				

                    <div class="agb">
                        <input type="checkbox" name="agb" required>
                        Ich stimme den <a href="../HTML/agb.html">AGBs</a> zu.
                    </div>

                    <div class="submit">
                        <input type="submit" id="submit" value="Registrieren" >
                    </div>
                    
                </form>
            </div>
        </div>

    </div>
    <!--ENDE FORMULAR-->

    
    <script>
        $(document).ready(function(){

        //ANMELDUNG
            $('#anmeldeformular').submit(function() {
                console.log('[sta] Ready for login!');

                //read from data
                const name = $('#name').val();
                const password = $('#passwort').val();
                var loginData = {name, password};
                var loginDataService = name+';'+password;

                console.log('[inf] Formdata: ', loginData);

                $.ajax({
                    url: 'http://localhost:8000/wba2api/person/login/'+loginDataService,
                    method: 'get',
                    dataType: 'json'

                }).done(function (response){
                    console.log('[sta] login successful!');
                    console.log('[sta] Response: UserID: ', response); //unter response.daten.id ist die ID gespeichert

                    setSessionItem('login', true);  //nachweis, dass jmd eingeloggt ist
                    setSessionItem('id', response.daten.id);    //id des benutzers in session speichern
                    
                    if (response.daten['id'] == 1){ //wenn admin eingeloggt auf nachrichten weiterleiten
                        window.location.replace('nachrichten.html');
                    }else{
                        //weiterleiten zur startseite
                        window.location.replace('index.html');
                    }


                }).fail(function(jqXHR,statusText,error) {
                    console.log("[err] response code: " + jqXHR.status + "\nerror msg: " + jqXHR.responseText);
                    console.log("[err] statusText: " + statusText + "\nerror: " + error);

                    //if wrong username
                    if (jqXHR.responseText.includes('No Record found by Benutzername')){
                        console.log("[fau] Username does not exist!");
                        $('#alertWrongUsername').html('Benutzername existiert nicht!');
                        $('#alertWrongPassword').html(''); //Meldung von Passwort entfernen
                    }

                    //if passwort is wrong, show alert
                    if (jqXHR.responseText.includes('Wrong password')){
                        console.log("[fau] Wrong password!");
                        $('#alertWrongPassword').html('Falsches Passwort! Erneut versuchen');
                        $('#alertWrongUsername').html(''); //Meldung von Benutzername entfernen
                    }
                });
                return false;

            });

        
        //REGISTRIERUNG
            $('#registrierungsform').submit(function() {
                console.log("[sta] Ready for signup!");

                //read form data
                function checkedRadio(){
                    const anrede = document.getElementsByName('anrede');
                    for (i=0; i < anrede.length; i++){
                        if (anrede[i].checked){return anrede[i].value;}
                    }
                }
                const anrede = checkedRadio();
                const vorname = $('#vorname').val();
                const nachname = $('#nachname').val();
                const benutzername = $('#benutzername').val();
                const email = $('#email').val();
                function passwortTrue(){
                    if (comparePasswords() == true){ //if both passwords are equal
                        return $('#passwort1').val();
                    } else {
                        alert("FEHLER! Passwörter stimmen nicht überein!");
                    }
                }
                const passwort = passwortTrue();
                const sfrage = $('#sicherheitsfrage').val();
                const santwort = $('#sicherheitsantwort').val();
                const strassehausnr = $('#strasse').val();
                function plzTrue(){
                    if (checkIfPLZ() == true){
                        return $('#plz').val().toString();
                    }else{
                        alert("FEHLER! PLZ falsch!");
                    }
                }
                const plz = plzTrue();
                const wohnort = $('#ort').val();
                var person = { 'anrede':anrede, 'vorname':vorname, 'nachname':nachname, 'benutzername':benutzername, 'email':email, 'passwort':passwort, 
                        'sicherheitsfrage':sfrage, 'sicherheitsantwort':santwort, 'strassehausnr':strassehausnr, 'plz':plz, 'wohnort':wohnort };

                console.log('[inf] Formdata: ' + JSON.stringify(person));

                // send form with ajax
                $.ajax({
                    type: 'get',
                    method: 'post',
                    url: 'http://localhost:8000/wba2api/person',
                    contentType: 'application/json',
                    data: JSON.stringify(person)
                }).done(function(response){
                    console.log("[inf] successfully signed up!");
                    window.location.replace("anmeldung.html");

                }).fail(function(jqXHR,statusText,error){
                    console.log("[err] response code: " + jqXHR.status + "\nerror msg: " + jqXHR.responseText);

                    if (jqXHR.responseText.includes('Username')){
                        console.log("Benutzername bereits vergeben.");
                        $('#alertUsername').html('Benutzername bereits vergeben!');
                    }
                });
                return false;
            });
        });
    </script>
    
    

    <!--FUSSLEISTE-->
    <hr width="100%" style="color: #00336a; margin-top: 20px;">
    <div class="footbox">
        <footer>
            <!--Fussleiste oben-->
            <div class="footer_top">
                <div class="footer_top_kontakt">
                    <h3>Noch Fragen?</h3>
                    <text>&#129046 <a href="../HTML/kontakt.html">zum Kontaktformular</a></text>
                </div>

                <div class="footer_top_zahlung">
                    <h3>Zahlungsarten</h3>
                    <table>
                        <tr>
                            <td><img src="../Bilder/footer_mastercard_logo.png" alt="mastercard"></td>
                            <td><img src="../Bilder/footer_visa_logo.png" alt="visa"></td>
                        </tr>
                        <tr>
                            <td><img src="../Bilder/footer_sepa_logo.png" alt="sepa"></td>
                            <td><img src="../Bilder/footer_auf_rechnung_logo.png" alt="auf rechnung"></td>
                        </tr>
                    </table> 
                </div>

                <div class="footer_top_versand">
                    <h3>Versandpartner</h3>
                    <img src="../Bilder/footer_hermes_logo.png" alt="hermes">
                </div>

                <div class="footer_top_folgen">
                    <h3>Folge uns:</h3>
                    <a href="facebook.com"><img src="../Bilder/footer_facebook_logo.png" alt="facebook"></a>
                    <a href="instagram.com"><img src="../Bilder/footer_insta_logo.png" alt="instagram"></a>
                </div>

            </div>

            <!--Fussleiste unten-->
            <div class="footer_bottom">
                <div class="footer_bottom_kategorien">
                    <h3>Kategorien</h3>
                    <a href="../HTML/produkt_hauptseite.html?oberkategorie=Sale">Sale</a><br>
                    <a href="../HTML/produkt_hauptseite.html?oberkategorie=Männer">Männer</a><br>
                    <a href="../HTML/produkt_hauptseite.html?oberkategorie=Frauen">Frauen</a><br>
                    <a href="../HTML/produkt_hauptseite.html?oberkategorie=Accessoires">Accessoires</a><br>
                </div>

                <div class="footer_bottom_rechtliches">
                    <h3>Rechtliches</h3>
                    <a href="../HTML/agb.html">AGB</a><br>
                    <a href="../HTML/impressum.html">Impressum</a><br>
                </div>

                <div class="footer_bottom_sponsoren">
                    <h3>Sponsoren & Partner</h3>
                    <a href="https://www.hs-albsig.de/hochschule/ueber-uns/hochschulportrait">
                        <img src="../Bilder/footer_hochschule_logo.png" alt="Hochschule">
                    </a><br>
                </div>

            </div>

        </footer>
    </div>
    <!--ENDE FUSSLEISTE-->
    

</body>

</html>
